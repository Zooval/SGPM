{% extends 'base.html' %}
{% load static %}

{% block title %}SGPM | Editar Tarea{% endblock %}
{% block page_title %}Editar Tarea{% endblock %}
{% block page_subtitle %}{{ tarea.id_tarea }}{% endblock %}

{% block page_content %}
<div class="card">
    <div class="card-content">
        <form method="post">
            {% csrf_token %}
            
            {% if request.session.asesor_rol == 'SUPERVISOR' %}
            {# Supervisor puede editar todos los campos #}
            <div class="form-group">
                <label class="form-label">
                    <i class="fa-solid fa-heading"></i>
                    Título *
                </label>
                <input type="text" name="titulo" class="form-control" required maxlength="200" value="{{ tarea.titulo }}">
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fa-solid fa-flag"></i>
                    Prioridad *
                </label>
                <select name="prioridad" class="form-control" required>
                    {% for prioridad in prioridades %}
                    <option value="{{ prioridad.value }}" {% if tarea.prioridad == prioridad.value %}selected{% endif %}>{{ prioridad.value }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fa-solid fa-user"></i>
                    Asignar a Asesor
                </label>
                <select name="asesor_email" class="form-control">
                    <option value="">Sin asignar</option>
                    {% for asesor in asesores %}
                    <option value="{{ asesor.email }}" {% if tarea.asesor_email == asesor.email %}selected{% endif %}>
                        {{ asesor.nombre_completo }} ({{ asesor.email }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fa-solid fa-calendar-times"></i>
                    Fecha de Vencimiento
                </label>
                <input type="datetime-local" name="vencimiento" class="form-control" 
                       value="{% if tarea.vencimiento %}{{ tarea.vencimiento|date:'Y-m-d\TH:i' }}{% endif %}">
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fa-solid fa-comment"></i>
                    Comentario
                </label>
                <textarea name="comentario" class="form-control" rows="3">{{ tarea.comentario }}</textarea>
            </div>
            {% else %}
            {# Asesor solo ve información de los demás campos (solo lectura) #}
            <div class="form-group">
                <label class="form-label">
                    <i class="fa-solid fa-heading"></i>
                    Título
                </label>
                <input type="text" class="form-control" value="{{ tarea.titulo }}" readonly style="background: var(--bg-main); cursor: not-allowed;">
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fa-solid fa-flag"></i>
                    Prioridad
                </label>
                <input type="text" class="form-control" value="{{ tarea.prioridad }}" readonly style="background: var(--bg-main); cursor: not-allowed;">
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fa-solid fa-calendar-times"></i>
                    Fecha de Vencimiento
                </label>
                <input type="text" class="form-control" 
                       value="{% if tarea.vencimiento %}{{ tarea.vencimiento|date:'d/m/Y H:i' }}{% else %}Sin vencimiento{% endif %}" 
                       readonly style="background: var(--bg-main); cursor: not-allowed;">
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fa-solid fa-comment"></i>
                    Comentario
                </label>
                <textarea name="comentario" class="form-control" rows="3">{{ tarea.comentario|default:"" }}</textarea>
            </div>
            {% endif %}

            {# Estado: editable para todos #}
            <div class="form-group">
                <label class="form-label">
                    <i class="fa-solid fa-toggle-on"></i>
                    Estado *
                </label>
                <select name="estado" class="form-control" required>
                    {% for estado in estados %}
                    <option value="{{ estado.value }}" {% if tarea.estado == estado.value %}selected{% endif %}>{{ estado.value }}</option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-main); border-radius: var(--radius-md);">
                <strong>Información de la tarea:</strong>
                <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem; color: var(--text-muted);">
                    <li>ID: {{ tarea.id_tarea }}</li>
                    <li>Asignada a: {% if tarea.asesor_email %}{{ tarea.asesor_email }}{% else %}Sin asignar{% endif %}</li>
                </ul>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="submit" class="btn-primary">
                    <i class="fa-solid fa-save"></i>
                    Guardar Cambios
                </button>
                <a href="{% url 'tareas_listar' %}" class="btn-secondary">
                    <i class="fa-solid fa-times"></i>
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

